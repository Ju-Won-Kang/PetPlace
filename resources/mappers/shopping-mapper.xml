<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="shoppingMapper">
	<resultMap id="shoppingResultSet" type="Shopping">
		<result column="PRODUCT_NO" property="productNo"/>
		<result column="PRODUCT_CATEGORY" property="productCategory"/>
		<result column="COMPANY" property="company"/>
		<result column="PRODUCT_NAME" property="productName"/>
		<result column="PRICE" property="price"/>
		<result column="INVENTORY" property="inventory"/>
		<result column="INGREDIENT" property="ingredient"/>
		<result column="ORIGIN" property="origin"/>
		<result column="PRODUCT_WEIGHT" property="productWeight"/>
		<result column="KCAL" property="kcal"/>
		<result column="ENROLL_DATE" property="enrollDate"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="STATUS" property="status"/>
		<result column="PRODUCT_IMG" property="productImg"/>
	</resultMap>
	<resultMap id="selectShoppingList" type="ShoppingList">
		<result column="PRODUCT_NO" property="productNo"/>
		<result column="PRODUCT_CATEGORY" property="productCategory"/>
		<result column="PRODUCT_NAME" property="productName"/>
		<result column="PRICE" property="price"/>
		<result column="PRODUCT_IMG" property="productImg"/>
		<result column="STAR" property="star"/>
		<result column="REVIEW_COUNT" property="reviewCount"/>
		<result column="PRODUCT_IMG" property="productImg"/>
	</resultMap>
	
	<resultMap  id="selectDetailResultSet" type="selectDetailProduct">
		<result column="PRODUCT_NO" property="productNo"/>
		<result column="PRODUCT_NAME" property="productName"/>
		<result column="PRICE" property="price"/>
		<result column="PRODUCT_IMG" property="productImg"/>
		<result column="FILE_PATH" property="detailImg"/>
		<result column="FILE_LEVEL" property="fileLevel" javaType="int"/>
		<result column="REVIEW_COUNT" property="reviewCount"/> <!-- reviewCount -->
		<result column="AVG_STAR" property="Star"/>
		<result column="COMPANY" property="company"/>
		<result column="INGREDIENT" property="ingredient"/>
		<result column="ORIGIN" property="origin"/>
		<result column="PRODUCT_WEIGHT" property="productWeight"/>
		<result column="KCAL" property="kcal"/>
	</resultMap>
	
	<resultMap id="ShoppingCompleteList" type="ShoppingComplete">
		<result column="MEMBER_NAME" property="memberName"/>
		<result column="PHONE" property="phone"/>
		<result column="MEMBER_ID" property="email"/>
		<result column="MEMBER_ADDRESS" property="address"/>
		<result column="REQUEST" property="request"/>
		<result column="WAYBILL" property="wayBill"/>
		<result column="PRODUCT_NAME" property="productName"/>
		<result column="AMOUNT_PRICE" property="amountPrice"/>
		<result column="PURCHASE_DATE" property="purchaseDate"/>
	</resultMap>
	
	<resultMap id="selectUserInfoList" type="UserInfo">
		<result column="MEMBER_NAME" property="userName"/>
		<result column="PHONE" property="phone"/>
		<result column="MEMBER_ADDRESS" property="address"/>
	</resultMap>
	
	<select id="selectShoppingListCount" resultType="_int">
		SELECT COUNT(*) AS "COUNT"
		  FROM PRODUCT
		 WHERE STATUS = 'Y'
		 <if test="category != null">
  		 	AND PRODUCT_CATEGORY = #{category}
  		 </if>
	</select>
	
	<select id="selectDetailProduct" resultMap="selectDetailResultSet" parameterType="_int">
		SELECT P.PRODUCT_NO,
		P.PRODUCT_NAME,
		P.PRICE,
		A.FILE_NO,
		A.FILE_PATH || A.CHANGE_NAME AS PRODUCT_IMG,
		A.FILE_LEVEL,
		COUNT(R.REVIEW_NO) AS REVIEW_COUNT,
		AVG(R.STAR) AS AVG_STAR,
		P.COMPANY,
		P.INGREDIENT,
		P.ORIGIN,
		P.PRODUCT_WEIGHT,
		P.KCAL
		FROM PRODUCT P
		LEFT JOIN REVIEW R ON P.PRODUCT_NO = R.PRODUCT_NO
		JOIN ATTACHMENT_PRODUCT A ON P.PRODUCT_NO = A.REF_PNO
		WHERE P.PRODUCT_NO = #{productNo}
		AND P.STATUS = 'Y'
		GROUP BY P.PRODUCT_NO, P.PRODUCT_NAME, P.PRICE, A.FILE_NO, A.FILE_PATH, A.CHANGE_NAME, A.FILE_LEVEL, P.COMPANY, P.INGREDIENT, P.ORIGIN, P.PRODUCT_WEIGHT, P.KCAL
	</select>

	<select id="selectShoppingAllList" resultMap="selectShoppingList">
		SELECT PRODUCT_NO,
		       PRODUCT_NAME,
		       PRICE,
		       PRODUCT_CATEGORY,
		       STAR,
		       COUNT(REVIEW_NO) AS "REVIEW_COUNT",
		       FILE_PATH || CHANGE_NAME AS "PRODUCT_IMG"
		  FROM PRODUCT P
		  JOIN ATTACHMENT_PRODUCT ON (PRODUCT_NO = REF_PNO)
		  LEFT JOIN REVIEW R USING(PRODUCT_NO)
		 WHERE P.STATUS = 'Y'
		   AND FILE_LEVEL = 1
		 GROUP BY PRODUCT_NO, 
		       PRODUCT_NAME, 
		       PRICE, 
		       PRODUCT_CATEGORY, 
		       STAR, 
		       FILE_PATH, 
		       CHANGE_NAME
		 ORDER BY PRODUCT_NO DESC
	</select>
	<select id="selectShoppingPetList" resultMap="selectShoppingList">
		SELECT PRODUCT_NO,
		       PRODUCT_NAME,
		       PRICE,
		       PRODUCT_CATEGORY,
		       STAR,
		       COUNT(REVIEW_NO) AS "REVIEW_COUNT",
		       FILE_PATH || CHANGE_NAME AS "PRODUCT_IMG"
		  FROM PRODUCT P
		  JOIN ATTACHMENT_PRODUCT ON (PRODUCT_NO = REF_PNO)
		  LEFT JOIN REVIEW R USING(PRODUCT_NO)
		 WHERE P.STATUS = 'Y'
		   AND FILE_LEVEL = 1
		 <if test="category != null">
  		 	AND PRODUCT_CATEGORY = #{category}
  		 </if>
		 GROUP BY PRODUCT_NO, 
		       PRODUCT_NAME, 
		       PRICE, 
		       PRODUCT_CATEGORY, 
		       STAR, 
		       FILE_PATH, 
		       CHANGE_NAME
		 ORDER BY PRODUCT_NO DESC
	</select>
	<select id="selectSearchPetCount" resultType="_int">
		SELECT COUNT(*)
  		  FROM PRODUCT
  		 WHERE STATUS = 'Y'
		 <if test="category != null">
  		 	AND PRODUCT_CATEGORY = #{category}
  		 </if>
  		    AND PRODUCT_NAME LIKE '%' || #{keyword} || '%'
	</select>
	<select id="selectSearchAllCount" resultType="_int">
		SELECT COUNT(*)
  		  FROM PRODUCT
  		 WHERE STATUS = 'Y'
  		   AND PRODUCT_NAME LIKE '%' || #{keyword} || '%'
	</select>
	<select id="selectSearchAllList" resultMap="selectShoppingList">
		SELECT PRODUCT_NO,
		       PRODUCT_NAME,
		       PRICE,
		       PRODUCT_CATEGORY,
		       STAR,
		       COUNT(REVIEW_NO) AS "REVIEW_COUNT",
		       FILE_PATH || CHANGE_NAME AS "PRODUCT_IMG"
		  FROM PRODUCT P
		  JOIN ATTACHMENT_PRODUCT ON (PRODUCT_NO = REF_PNO)
		  LEFT JOIN REVIEW R USING(PRODUCT_NO)
		 WHERE P.STATUS = 'Y'
		   AND FILE_LEVEL = 1
		   AND PRODUCT_NAME LIKE '%' || #{keyword} || '%'
		 GROUP BY PRODUCT_NO, 
		       PRODUCT_NAME, 
		       PRICE, 
		       PRODUCT_CATEGORY, 
		       STAR,
		       FILE_PATH, 
		       CHANGE_NAME
		 ORDER BY PRODUCT_NO DESC
	</select>
	<select id="selectSearchPetList" resultMap="selectShoppingList">
		SELECT PRODUCT_NO,
		       PRODUCT_NAME,
		       PRICE,
		       PRODUCT_CATEGORY,
		       STAR,
		       COUNT(REVIEW_NO) AS "REVIEW_COUNT",
		       FILE_PATH || CHANGE_NAME AS "PRODUCT_IMG"
		  FROM PRODUCT P
		  JOIN ATTACHMENT_PRODUCT ON (PRODUCT_NO = REF_PNO)
		  LEFT JOIN REVIEW R USING(PRODUCT_NO)
		 WHERE P.STATUS = 'Y'
		   AND FILE_LEVEL = 1
		 <if test="category != null">
  		 	AND PRODUCT_CATEGORY = #{category}
  		 </if>
  		    AND PRODUCT_NAME LIKE '%' || #{keyword} || '%'
		 GROUP BY PRODUCT_NO, 
		       PRODUCT_NAME, 
		       PRICE, 
		       PRODUCT_CATEGORY, 
		       STAR, 
		       FILE_PATH, 
		       CHANGE_NAME
		 ORDER BY PRODUCT_NO DESC
	</select>
	
	<select id="selectShoppingCompleteList" resultMap="ShoppingCompleteList">
		SELECT MEMBER_NAME,
			   PHONE,
			   MEMBER_ID,
			   MEMBER_ADDRESS,
			   REQUEST,
			   WAYBILL,
			   PRODUCT_NAME,
			   AMOUNT_PRICE,
			   PURCHASE_DATE
		  FROM MEMBER
		  JOIN PURCHASE USING(MEMBER_ID)
		  JOIN PRODUCT USING(PRODUCT_NO)
		 WHERE PRODUCT_NO = #{productNo}
	</select>
	
	<!-- 유저정보 가져오는 sql -->
	<select id="selectUserInfoList" resultMap="UserInfo">
		 SELECT	MEMBER_NAME,
		 		PHONE,
		 		MEMBER_ADDRESS
		   FROM MEMBER
		  WHERE	USER_ID = #{userId}
	</select>
</mapper>